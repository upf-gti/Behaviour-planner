<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, height=device-height,initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>Behaviour Planner Player</title>
    <style type='text/css'>
		html, body {
			width: 100%;
			height: 100%;
			margin: 0;
			padding: 0;
            overflow: hidden;
            background-color: black;
		}
	</style>
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <link rel="stylesheet" type="text/css" href="./css/player.css"></link>
</head>
<body >
    <div class="container">
        <div class="menu-container">
            <div id="menu" class="menu-button"><svg width="28" height="28" fill="none" data-testid="menu-icon" class="menu-icon"><circle cx="14" cy="14" r="14" fill="#fff"></circle><path d="M14 10.667c.917 0 1.667-.75 1.667-1.667s-.75-1.667-1.666-1.667c-.917 0-1.667.75-1.667 1.667s.75 1.667 1.667 1.667zm0 1.666c-.916 0-1.666.75-1.666 1.667s.75 1.667 1.667 1.667c.916 0 1.666-.75 1.666-1.667s-.75-1.667-1.666-1.667zm0 5c-.916 0-1.666.75-1.666 1.667s.75 1.667 1.667 1.667c.916 0 1.666-.75 1.666-1.667s-.75-1.667-1.666-1.667z" fill="#000"></path></svg></div>
            <div id="options" class="menu-options">
                <a href="#chat">Show chat</a>
                <a href="#settings">Settings</a>
                <a href="#about">About</a>
            </div>
        </div>
        <div class="bottom-bar">
            <div class="text"></div>
            <div class="user-input"></div>
            <div class="bottom-bar-center">
                <div class="bottom-center">
                    <div class="input-container">
                        <div></div>
                        <div class="input-text">
                            <div><input type="text" id="chat" placeholder="Type something" class="" value=""></div>
                        </div>
                        <div class="input-button">
                            <button id="mic" class="MuiButtonBase-root MuiIconButton-root" tabindex="0" type="button" aria-label="add" style="cursor: pointer; color: rgb(255, 255, 255); margin-right: 12px; transition: border-radius 0.25s ease 0s; opacity: 1; border-radius: 0px; background-color: rgba(255, 255, 255, 0);"><span class="MuiIconButton-label">
                                <svg class="MuiSvgIcon-root" focusable="false"xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-mic-fill" viewBox="0 0 16 16">
                                <path d="M5 3a3 3 0 0 1 6 0v5a3 3 0 0 1-6 0V3z"/>
                                <path d="M3.5 6.5A.5.5 0 0 1 4 7v1a4 4 0 0 0 8 0V7a.5.5 0 0 1 1 0v1a5 5 0 0 1-4.5 4.975V15h3a.5.5 0 0 1 0 1h-7a.5.5 0 0 1 0-1h3v-2.025A5 5 0 0 1 3 8V7a.5.5 0 0 1 .5-.5z"/>
                            </svg></span>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
            <div class="right"></div>
        </div>
        <div id = "chat-container" class="transcript-container" style="transform: translate(0px, 0px);">
            <div class="react-draggable transcript" style="transform: translate(0px, 0px);">
                <div class="transcript-container-header">
                    <div class="transcript-header">
                        <div class="download-button">
                            <div class="transcript-tooltip tooltip-right">Download</div>
                            <svg width="17" height="15" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M15.58 12.72a.658.658 0 010 1.315H1.545a.658.658 0 010-1.316H15.58zM8.546 0a.658.658 0 01.674.641l.203 8.135 3.114-2.491a.658.658 0 01.864.036l.06.066a.658.658 0 01-.102.925l-4.386 3.509a.658.658 0 01-.822 0L3.765 7.312a.658.658 0 11.822-1.027l3.528 2.822-.21-8.433a.658.658 0 01.552-.666L8.546 0z" fill="currentColor"></path></svg>
                        </div>
                        <div id= "minimise" class="close-button">
                            <div class="transcript-tooltip tooltip-left">Minimise Transcript</div>
                            <div class="close-icon">
                                <svg width="24" height="24" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><defs><path d="M4.308 4.308a1.053 1.053 0 011.49 0l6.702 6.703 6.702-6.703c.38-.38.977-.408 1.39-.087l.1.087a1.053 1.053 0 010 1.49L13.989 12.5l6.703 6.702c.38.38.408.977.087 1.39l-.087.1a1.053 1.053 0 01-1.49 0L12.5 13.989l-6.702 6.703c-.38.38-.977.408-1.39.087l-.1-.087a1.053 1.053 0 010-1.49l6.703-6.702-6.703-6.702a1.053 1.053 0 01-.087-1.39z" id="close_svg__a"></path></defs><use fill="currentColor" fill-rule="nonzero" xlink:href="#close_svg__a"></use></svg>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="transcript-content">
                    <div class="transcript-chat">
                        <div class="avatar-message">
                            <div class="message">&lt;uneeq:happy&gt;Hi! My name is Sophie, what's your name?&lt;/uneeq:happy&gt;</div>
                        </div>
                        <div class="user-message">
                            <div class="message">MO</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <!--Behaviour planner core and its de dependencies-->
    <script src="../src/libs/gl-matrix-min-2_8.js"></script>
    <script src="./js/libs/litegl.js"></script>
    <script src="../src/libs/litegraph.js"></script>
    <script src="../src/libs/HBTree.js"></script>
    <script src="../src/libs/extra/onecore.js"></script>
    <script src="../src/libs/extra/Canvas2DtoWebGL.js"></script>
    <!--Web app dependencies-->
    <!--<script src="js/libs/litegui.js"></script>
    <script src="js/libs/HBTEditor.js"></script>
    <script src="js/libs/litegraph.js"></script>-->

    <!--Web app core-->
    <script src="../src/entitiesManager.js"></script>
    <script src="../src/behaviourNodes.js"></script>
    <script src="../src/behaviourGraph.js"></script>
    <script src="../src/behaviourPlanner.js"></script>
    <script src="../src/behaviourPresenter.js"></script>
    <script src="../src/timeline_node.js"></script>
    <script src="../src/utils.js"></script>
 
    
    <script>
     /*------------------------------------- LOAD ENVIRONMENT -------------------------------------*/
        var settings = {
            alpha: false, //enables to have alpha in the canvas to blend with background
            stencil: true,
            redraw: true, //force to redraw
            autoplay: Boolean(LS.queryString["autoplay"]),
            resources: "https://webglstudio.org/fileserver/",
            autoresize: true, //resize the 3D window if the browser window is resized
            loadingbar: true, //shows loading bar progress
            proxy: "https://webglstudio.org/projects/present/repository/files/" //allows to proxy request to avoid cross domain problems, in this case the @ means same domain, so it will be http://hostname/proxy
        };
        var BP = new BehaviourPlanner.Loader(settings)//new BehaviourPlanner(null,settings);
        var query_string = LS.queryString;
        if( query_string["session"] )
            player.setScene( JSON.parse( localStorage.getItem( query_tring["session"] ) ) );
        else if( (query_string["url"] && query_string["url"].indexOf("://") == -1) ) //for safety measures
            BP.loadPlanner( query_string["url"], BP.loadScene.bind(BP) ); //the url must be something like: fileserver/files/guest/projects/Lee_FX.json
        else if( query_string["preview"] === undefined )
            BP.loadConfig("config_BPplayer.json", BP.loadPlanner.bind(BP));
      //  BP.animate();

     /*------------------------------------- USER INTERACTION -------------------------------------*/
     
        var SpeechRecognition = SpeechRecognition || webkitSpeechRecognition
        var recognition = new SpeechRecognition();
        recognition.lang = 'en-GB';
        
        var mouseDown = false;
        var micBtn = document.getElementById("mic");
        micBtn.addEventListener("mousedown", startSpeech)
        micBtn.addEventListener("mouseup",stopSpeech)
        document.body.onkeydown = function(e){
            if(e.keyCode == 32) startSpeech(e);
        }
        document.body.onkeyup = function(e){
            if(e.keyCode == 32) stopSpeech(e)
            if(e.keyCode == 13) onUserText(e)
        }
        function onUserText(){
            var value = document.getElementById("chat").value;
            var msg = {
                type:"data",
                data:{ user: {text: value}}
            }
            showUserMessage(value)
            BP.bp.onData(msg)
            document.getElementById("chat").value = "";
        }
        function startSpeech(e){
            micBtn.classList.add("active")
            e.preventDefault()
            if(!mouseDown)
            {
                recognition.start();
                var msg =  [ {type: "control", state: "LISTENING", start:0, end:10,  composition: "OVERWRITE"}]
                BP.bp.onActions(msg)
            }
                
            mouseDown = true;
            
        }
        function stopSpeech(e){
            micBtn.classList.remove("active")
            if(mouseDown)
                recognition.stop();
            mouseDown = false;
        }

        recognition.onresult = function(event) {
            var transcription = event.results[0][0].transcript;
            if(event.results[0].isFinal){
                var msg = {
                    type:"data",
                    data:{ user: {text: transcription}}
                }
                showUserMessage(transcription)
                BP.bp.onData(msg)
            }
                
            console.log(transcription)
            console.log('Confidence: ' + event.results[0][0].confidence);
            }
        /*MENU*/
        var menuBtn = document.getElementById("menu");
        menuBtn.addEventListener("click", function(e){
            document.getElementById("options").classList.toggle("show");
            e.stopPropagation()
        })
        
        // Close the dropdown if the user clicks outside of it
        window.onclick = function(event) {
            if (!event.target.matches('#menu')) {
                var options = document.getElementsByClassName("menu-options");
                for(var i = 0; i < options.length; i++) {
                    var option = options[i];
                    if (option.classList.contains('show')) {
                        option.classList.remove('show');
                    }
                }
            }
            if(event.target.parentNode.className == "close-button"){
                window.location.hash = "";
                document.getElementsByClassName("transcript-container")[0].classList.remove("show-chat")
            }
            else if (event.target.parentNode.className == "download-button"){
                
            }
        }
        window.addEventListener('hashchange', function(event){
            var hash = window.location.hash;
            if(hash == "#chat")
                document.getElementsByClassName("transcript-container")[0].classList.add("show-chat");
            else
                document.getElementsByClassName("transcript-container")[0].classList.remove("show-chat")
        })

        function showUserMessage(text){
            var chat = document.getElementsByClassName("transcript-chat")[0];
            var msgDiv = document.createElement("div");
            msgDiv.className = "user-message";

            var msg = document.createElement("div");
            msg.className = "message";
            msg.innerText = text;

            msgDiv.appendChild(msg);
            chat.appendChild(msgDiv);
        }

        //---------------------- Make the DIV element draggable:
        dragElement(document.getElementById("chat-container"), document.getElementsByClassName("transcript-header")[0] );

        function dragElement(elmnt, header) {
            var pos1 = 0, pos2 = 0, pos3 = 0, pos4 = 0;
           /* if (header) {
                header.draggable = true;
                // if present, the header is where you move the DIV from:
                header.onmousedown = dragMouseDown;
            } else {*/
                // otherwise, move the DIV from anywhere inside the DIV:
                elmnt.onmousedown = dragMouseDown;
                elmnt.draggable = true;
           /* }*/

            function dragMouseDown(e) {
                e = e || window.event;
                e.preventDefault();
                // get the mouse cursor position at startup:
                pos3 = e.clientX;
                pos4 = e.clientY;
                document.onmouseup = closeDragElement;
                // call a function whenever the cursor moves:
                document.onmousemove = elementDrag;
            }

            function elementDrag(e) {
                e = e || window.event;
                e.preventDefault();
                // calculate the new cursor position:
                pos1 = pos3 - e.clientX;
                pos2 = pos4 - e.clientY;
                pos3 = e.clientX;
                pos4 = e.clientY;
                // set the element's new position:
                elmnt.style.top = (elmnt.offsetTop - pos2) + "px";
                elmnt.style.left = (elmnt.offsetLeft - pos1) + "px";
            }

            function closeDragElement() {
                // stop moving when mouse button is released:
                document.onmouseup = null;
                document.onmousemove = null;
            }
        }
    </script>
    </body>
</html>
