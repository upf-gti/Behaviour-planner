
//TODO
//main.js should act as a websocket server instead of as a client so third applications can connect directly
var UTILS = require("../src/utils.js").UTILS;
/*var Streamer = require("../src/streamer.js").Streamer;
var streamer = new Streamer();
console.log(streamer);*/


//Dependencies:
//npm install gl-matrix

//Base of node graph system. (There are some modifications to make it work properly with gl-matrix)
var LiteGraph = require("../src/libs/litegraph").LiteGraph;

//Expand graph system with behaviour trees and many nodes
var HBTree = require("../src/libs/HBTree")(LiteGraph);
var graphNodes = require("../src/graphNodes")(LiteGraph, HBTree);
var BP = require("./behaviourPlanner")(LiteGraph,HBTree,graphNodes);
//console.log(LiteGraph.Nodes);

var behaviorData = {
    "env":{
        "agents":[
            {"uid":"Agent-1600260845413","num_id":0,"btree":null,"hbtgraph":"default","properties":{"name":"Agent-1600260845413","valence":0,"arousal":0,"age":35,"target":null,"look_at_pos":[0,0,10000],"position":[0,0,0],"orientation":[0,0,0,1],"state":"waiting"},"gestures":[{"name":"smile","duration":"Short-term","priority":"append","interface":"smile","keywords":"ssmile","properties":{}},{"name":"jaw_open","duration":"Short-term","priority":"append","interface":"jaw","keywords":"","properties":{"intensity":1}}]}
        ],
        "graphs":[
            {"behaviour":{"last_node_id":66,"last_link_id":81,"nodes":[{"id":2,"type":"btree/BoolConditional","pos":[290.00000190734863,254.03693389892578],"size":{"0":210,"1":78},"flags":{},"order":11,"mode":0,"inputs":[{"name":"","type":"path","link":37,"pos":[100,-30],"dir":1},{"name":"value","type":"boolean","link":48,"pos":[0,40],"dir":3}],"outputs":[{"name":"","type":"path","links":[3],"pos":[100,80],"dir":2}],"properties":{"min":0,"max":100,"title":"","property_to_compare":"","value_to_compare":false,"bool_state":true},"widgets_values":[true],"color":"#233","bgcolor":"#355","boxcolor":"#999","shape":2},{"id":17,"type":"btree/Wait","pos":[602.8346299999993,776.3496109999994],"size":{"0":210,"1":38},"flags":{"horizontal":true},"order":20,"mode":0,"inputs":[{"name":"","type":"path","link":16}],"properties":{"total_time":5},"widgets_values":[5],"color":"#2e542e","bgcolor":"#496b49","boxcolor":"#999","shape":2},{"id":5,"type":"btree/Selector","pos":[317,402],"size":{"0":140,"1":26},"flags":{"horizontal":true},"order":14,"mode":0,"inputs":[{"name":"","type":"path","link":3}],"outputs":[{"name":"","type":"path","links":[4,34,15]}],"properties":{"value":1},"color":"#6e1212","bgcolor":"#702d2d","boxcolor":"#999","shape":2},{"id":34,"type":"btree/Conditional","pos":[286,530.3705892167968],"size":{"0":210,"1":102},"flags":{},"order":16,"mode":0,"inputs":[{"name":"","type":"path","link":34,"pos":[100,-30],"dir":1},{"name":"value","type":0,"link":36,"pos":[0,60],"dir":3}],"outputs":[{"name":"","type":"path","links":[35],"pos":[100,102],"dir":2}],"properties":{"min":0,"max":100,"text":"threshold","property_to_compare":"","limit_value":"speak","value_to_compare":"wait","comparison_type":"=="},"widgets_values":["==","speak"],"color":"#233","bgcolor":"#355","boxcolor":"#999","shape":2},{"id":35,"type":"btree/HBTproperty","pos":[53,552.3705892167968],"size":{"0":210,"1":78},"flags":{},"order":0,"mode":0,"outputs":[{"name":"value","type":"","links":[36],"pos":[210,55],"dir":4},{"name":"name","type":"string","links":[],"pos":[210,35],"dir":4},{"name":"root","type":"string","links":null,"pos":[210,75],"dir":4}],"title":"state","properties":{"value":null,"type":"string","property_name":"state"},"widgets_values":["string"],"color":"#907300","bgcolor":"#796B31","boxcolor":"#999","shape":2,"property_type":"agent"},{"id":11,"type":"btree/Selector","pos":[309.68779999999987,702.8880532167973],"size":{"0":140,"1":26},"flags":{"horizontal":true},"order":19,"mode":0,"inputs":[{"name":"","type":"path","link":35}],"outputs":[{"name":"","type":"path","links":[45]}],"properties":{"value":1},"color":"#6e1212","bgcolor":"#702d2d","boxcolor":"#999","shape":2},{"id":36,"type":"btree/Root","pos":[476.78400190429636,-35.42127343750019],"size":{"0":140,"1":26},"flags":{},"order":1,"mode":0,"outputs":[{"name":"","type":"path","links":[37,50]}],"properties":{},"color":"#1E1E1E","boxcolor":"#999","shape":2},{"id":50,"type":"btree/HBTproperty","pos":[585.1726087460937,342.12116339257824],"size":{"0":215.72999572753906,"1":98.37985229492188},"flags":{},"order":2,"mode":0,"outputs":[{"name":"value","type":"","links":[],"pos":[210,55],"dir":4},{"name":"name","type":"string","links":[58],"pos":[210,35],"dir":4},{"name":"root","type":"string","links":[59],"pos":[210,75],"dir":4}],"title":"state","properties":{"value":null,"type":"string","property_name":"state"},"widgets_values":["string"],"color":"#907300","bgcolor":"#796B31","boxcolor":"#999","shape":2,"property_type":"agent"},{"id":52,"type":"btree/SetProperty","pos":[880.1726087460937,355.12116339257824],"size":{"0":210,"1":66},"flags":{},"order":12,"mode":0,"inputs":[{"name":"","type":"path","link":60,"pos":[100,-30],"dir":1},{"name":"name","type":0,"link":58,"pos":[0,35],"dir":3},{"name":"root","type":0,"link":59,"pos":[0,55],"dir":3}],"properties":{"value":"wait","property_to_compare":"state"},"widgets_values":["wait"],"color":"#2e542e","bgcolor":"#496b49","boxcolor":"#999","shape":2},{"id":53,"type":"btree/Conditional","pos":[-107.16569281250005,1268.8646690468759],"size":{"0":210,"1":102},"flags":{},"order":24,"mode":0,"inputs":[{"name":"","type":"path","link":81,"pos":[100,-30],"dir":1},{"name":"value","type":0,"link":72,"pos":[0,60],"dir":3}],"outputs":[{"name":"","type":"path","links":[65],"pos":[100,102],"dir":2}],"properties":{"min":0,"max":100,"text":"threshold","property_to_compare":"","limit_value":"0","value_to_compare":-0.2680000066757202,"comparison_type":"<"},"widgets_values":["<","0"],"color":"#233","bgcolor":"#355","boxcolor":"#999","shape":2},{"id":57,"type":"btree/HBTproperty","pos":[-533.4507831445305,1569.3037862343756],"size":{"0":210,"1":98},"flags":{},"order":3,"mode":0,"outputs":[{"name":"value","type":"","links":null,"pos":[210,55],"dir":4},{"name":"name","type":"string","links":[66],"pos":[210,35],"dir":4},{"name":"root","type":"string","links":[67],"pos":[210,75],"dir":4}],"title":"valence","properties":{"value":0,"type":"number","property_type":"agent","property_name":"valence"},"widgets_values":["number"],"color":"#907300","bgcolor":"#796B31","boxcolor":"#999","shape":2,"property_type":"agent"},{"id":60,"type":"btree/SetProperty","pos":[-253.16569281250025,1581.8646690468759],"size":{"0":210,"1":96},"flags":{},"order":27,"mode":0,"inputs":[{"name":"","type":"path","link":68,"pos":[100,-30],"dir":1},{"name":"name","type":0,"link":66,"pos":[0,35],"dir":3},{"name":"root","type":0,"link":67,"pos":[0,55],"dir":3}],"properties":{"value":"1","property_to_compare":"valence"},"widgets_values":["1"],"color":"#2e542e","bgcolor":"#496b49","boxcolor":"#999","shape":2},{"id":62,"type":"btree/HBTproperty","pos":[5.834307187500027,1571.8646690468759],"size":{"0":210,"1":98},"flags":{},"order":4,"mode":0,"outputs":[{"name":"value","type":"","links":null,"pos":[210,55],"dir":4},{"name":"name","type":"string","links":[69],"pos":[210,35],"dir":4},{"name":"root","type":"string","links":[70],"pos":[210,75],"dir":4}],"title":"arousal","properties":{"value":0,"type":"number","property_type":"agent","property_name":"arousal"},"widgets_values":["number"],"color":"#907300","bgcolor":"#796B31","boxcolor":"#999","shape":2,"property_type":"agent"},{"id":59,"type":"btree/Parallel","pos":[5.604235898437647,1462.8237786660166],"size":{"0":140,"1":26},"flags":{"horizontal":true},"order":26,"mode":0,"inputs":[{"name":"","type":"path","link":65}],"outputs":[{"name":"","type":"path","links":[68,71]}],"properties":{"value":1},"color":"#6e1212","bgcolor":"#702d2d","boxcolor":"#999","shape":2},{"id":16,"type":"btree/Sequencer","pos":[783,584],"size":{"0":140,"1":26},"flags":{"horizontal":true},"order":17,"mode":0,"inputs":[{"name":"","type":"path","link":15}],"outputs":[{"name":"","type":"path","links":[16,75,33]}],"properties":{"value":1},"color":"#6e1212","bgcolor":"#702d2d","boxcolor":"#999","shape":2},{"id":64,"type":"btree/SetProperty","pos":[908,792],"size":{"0":210,"1":66},"flags":{},"order":21,"mode":0,"inputs":[{"name":"","type":"path","link":75,"pos":[100,-30],"dir":1},{"name":"name","type":0,"link":73,"pos":[0,35],"dir":3},{"name":"root","type":0,"link":74,"pos":[0,55],"dir":3}],"properties":{"value":"speak","property_to_compare":"state"},"widgets_values":["speak"],"color":"#2e542e","bgcolor":"#496b49","boxcolor":"#999","shape":2},{"id":28,"type":"btree/HBTproperty","pos":[-708.7926167441398,1167.445134269532],"size":{"0":227.58184814453125,"1":92.832275390625},"flags":{},"order":5,"mode":0,"outputs":[{"name":"value","type":"","links":[],"pos":[210,55],"dir":4},{"name":"name","type":"string","links":[76],"pos":[210,35],"dir":4},{"name":"root","type":"string","links":[77],"pos":[210,75],"dir":4}],"title":"state","properties":{"value":null,"type":"string","property_name":"state"},"widgets_values":["string"],"color":"#907300","bgcolor":"#796B31","boxcolor":"#999","shape":2,"property_type":"agent"},{"id":33,"type":"btree/ActionAnimate","pos":[1165,784],"size":{"0":210,"1":62},"flags":{},"order":22,"mode":0,"inputs":[{"name":"","type":"path","link":33}],"properties":{"anims":[{"name":null,"weight":1}],"translation_enabled":true,"time":1,"src":"david8more/projects/SAUCE/Animations/","filename":"startconversation"},"widgets_values":["startConversation",1],"color":"#2e542e","bgcolor":"#496b49","boxcolor":"#999","shape":2},{"id":45,"type":"btree/HBTproperty","pos":[-20,239],"size":{"0":210,"1":78},"flags":{},"order":6,"mode":0,"outputs":[{"name":"value","type":"","links":[48],"pos":[210,55],"dir":4},{"name":"name","type":"string","links":null,"pos":[210,35],"dir":4},{"name":"root","type":"string","links":null,"pos":[210,75],"dir":4}],"title":"is_in_front","properties":{"value":false,"type":"boolean","property_name":"is_in_front"},"widgets_values":["boolean"],"color":"#907300","bgcolor":"#796B31","boxcolor":"#999","shape":2,"property_type":"user"},{"id":65,"type":"btree/SetProperty","pos":[-415.16569281249946,1144.8646690468756],"size":{"0":210,"1":66},"flags":{},"order":23,"mode":0,"inputs":[{"name":"","type":"path","link":80,"pos":[100,-30],"dir":1},{"name":"name","type":0,"link":76,"pos":[0,35],"dir":3},{"name":"root","type":0,"link":77,"pos":[0,55],"dir":3}],"properties":{"value":"listen","property_to_compare":"state"},"widgets_values":["listen"],"color":"#2e542e","bgcolor":"#496b49","boxcolor":"#999","shape":2},{"id":66,"type":"btree/Parallel","pos":[-365.57691107421846,1036.1477501015625],"size":{"0":140,"1":26},"flags":{"horizontal":true},"order":18,"mode":0,"inputs":[{"name":"","type":"path","link":79}],"outputs":[{"name":"","type":"path","links":[80,81]}],"properties":{"value":1},"color":"#6e1212","bgcolor":"#702d2d","boxcolor":"#999","shape":2},{"id":42,"type":"graph/subgraph","pos":[307,848.3705892167968],"size":[140,106],"flags":{},"order":25,"mode":0,"inputs":[{"name":"","type":"path","link":45,"pos":[70,-30],"dir":1},{"name":"","type":"path","link":null,"pos":[70,-30],"dir":1},{"name":"","type":"path","link":null,"pos":[70,-30],"dir":1},{"name":"","type":"path","link":null,"pos":[70,-30],"dir":1}],"title":"Speak state","properties":{"enabled":true},"subgraph":{"last_node_id":4,"last_link_id":3,"nodes":[{"id":2,"type":"btree/Selector","pos":[394,318],"size":{"0":140,"1":26},"flags":{"horizontal":true},"order":1,"mode":0,"inputs":[{"name":"","type":"path","link":3}],"outputs":[{"name":"","type":"path","links":[2]}],"properties":{"value":1},"color":"#6e1212","bgcolor":"#702d2d","boxcolor":"#999","shape":2},{"id":3,"type":"btree/ActionAnimate","pos":[363,453],"size":{"0":210,"1":62},"flags":{},"order":2,"mode":0,"inputs":[{"name":"","type":"path","link":2}],"properties":{"anims":[{"name":null,"weight":1}],"translation_enabled":true,"time":1,"src":"david8more/projects/SAUCE/Animations/","filename":"subgraph"},"widgets_values":["subgraph",1],"color":"#2e542e","bgcolor":"#496b49","boxcolor":"#999","shape":2},{"id":4,"type":"btree/Root","pos":[398,168],"size":{"0":140,"1":26},"flags":{},"order":0,"mode":0,"outputs":[{"name":"","type":"path","links":[3]}],"properties":{},"color":"#1E1E1E","boxcolor":"#999","shape":2}],"links":[[2,2,0,3,0,"path"],[3,4,0,2,0,"path"]],"groups":[],"config":{},"extra":{},"version":0.4}},{"id":63,"type":"btree/HBTproperty","pos":[-404.1656928124997,1289.8646690468759],"size":{"0":210,"1":98},"flags":{},"order":7,"mode":0,"outputs":[{"name":"value","type":"","links":[72],"pos":[210,55],"dir":4},{"name":"name","type":"string","links":null,"pos":[210,35],"dir":4},{"name":"root","type":"string","links":null,"pos":[210,75],"dir":4}],"title":"valence","properties":{"value":0,"type":"number","property_type":"user","property_name":"valence"},"widgets_values":["number"],"color":"#907300","bgcolor":"#796B31","boxcolor":"#999","shape":2,"property_type":"user"},{"id":61,"type":"btree/SetProperty","pos":[297.78325856249995,1569.7412394687499],"size":{"0":210,"1":96},"flags":{},"order":28,"mode":0,"inputs":[{"name":"","type":"path","link":71,"pos":[100,-30],"dir":1},{"name":"name","type":0,"link":69,"pos":[0,35],"dir":3},{"name":"root","type":0,"link":70,"pos":[0,55],"dir":3}],"properties":{"value":"0","property_to_compare":"arousal"},"widgets_values":["0"],"color":"#2e542e","bgcolor":"#496b49","boxcolor":"#999","shape":2},{"id":46,"type":"btree/HBTproperty","pos":[-604.8973680000003,564.0862440000001],"size":{"0":210,"1":78},"flags":{},"order":8,"mode":0,"outputs":[{"name":"value","type":"","links":[49],"pos":[210,55],"dir":4},{"name":"name","type":"string","links":null,"pos":[210,35],"dir":4},{"name":"root","type":"string","links":null,"pos":[210,75],"dir":4}],"title":"is_speaking","properties":{"value":false,"type":"boolean","property_name":"is_speaking"},"widgets_values":["boolean"],"color":"#907300","bgcolor":"#796B31","boxcolor":"#999","shape":2,"property_type":"user"},{"id":4,"type":"btree/BoolConditional","pos":[-342,574],"size":{"0":210,"1":78},"flags":{},"order":15,"mode":0,"inputs":[{"name":"","type":"path","link":4,"pos":[100,-30],"dir":1},{"name":"value","type":"boolean","link":49,"pos":[0,40],"dir":3}],"outputs":[{"name":"","type":"path","links":[79],"pos":[100,80],"dir":2}],"properties":{"min":0,"max":100,"title":"","property_to_compare":"","value_to_compare":false,"bool_state":true},"widgets_values":[true],"color":"#233","bgcolor":"#355","boxcolor":"#999","shape":2},{"id":31,"type":"btree/HBTproperty","pos":[599,878],"size":{"0":219.178466796875,"1":89.12898254394531},"flags":{},"order":9,"mode":0,"outputs":[{"name":"value","type":"","links":[],"pos":[210,55],"dir":4},{"name":"name","type":"string","links":[73],"pos":[210,35],"dir":4},{"name":"root","type":"string","links":[74],"pos":[210,75],"dir":4}],"title":"state","properties":{"value":null,"type":"string","property_name":"state"},"widgets_values":["string"],"color":"#907300","bgcolor":"#796B31","boxcolor":"#999","shape":2,"property_type":"agent"},{"id":47,"type":"btree/ActionAnimate","pos":[1230.1726087460938,366.12116339257824],"size":{"0":210,"1":62},"flags":{},"order":13,"mode":0,"inputs":[{"name":"","type":"path","link":54}],"properties":{"anims":[{"name":null,"weight":1}],"translation_enabled":true,"time":1,"src":"david8more/projects/SAUCE/Animations/","filename":"idle"},"widgets_values":["idle",1],"color":"#2e542e","bgcolor":"#496b49","boxcolor":"#999","shape":2},{"id":48,"type":"btree/Sequencer","pos":[1013.1726087460936,156.12116339257813],"size":{"0":140,"1":26},"flags":{"horizontal":true},"order":10,"mode":0,"inputs":[{"name":"","type":"path","link":50}],"outputs":[{"name":"","type":"path","links":[60,54]}],"properties":{"value":1},"color":"#6e1212","bgcolor":"#702d2d","boxcolor":"#999","shape":2}],"links":[[3,2,0,5,0,"path"],[4,5,0,4,0,"path"],[15,5,0,16,0,"path"],[16,16,0,17,0,"path"],[33,16,0,33,0,"path"],[34,5,0,34,0,"path"],[35,34,0,11,0,"path"],[36,35,0,34,1,0],[37,36,0,2,0,"path"],[45,11,0,42,0,"path"],[48,45,0,2,1,"boolean"],[49,46,0,4,1,"boolean"],[50,36,0,48,0,"path"],[54,48,0,47,0,"path"],[58,50,1,52,1,0],[59,50,2,52,2,0],[60,48,0,52,0,"path"],[65,53,0,59,0,"path"],[66,57,1,60,1,0],[67,57,2,60,2,0],[68,59,0,60,0,"path"],[69,62,1,61,1,0],[70,62,2,61,2,0],[71,59,0,61,0,"path"],[72,63,0,53,1,0],[73,31,1,64,1,0],[74,31,2,64,2,0],[75,16,0,64,0,"path"],[76,28,1,65,1,0],[77,28,2,65,2,0],[79,4,0,66,0,"path"],[80,66,0,65,0,"path"],[81,66,0,53,0,"path"]],"groups":[{"title":"User speaking","bounding":[-709,991,1239,762],"color":"#3f789e"},{"title":"Agent speaking","bounding":[-76,479,640,501],"color":"#a1309b"},{"title":"Agent start speaking","bounding":[594,470,816,525],"color":"#8A8"},{"title":"Waiting (not user in front)","bounding":[582,121,933,328],"color":"#b58b2a"}],"config":{},"extra":{},"version":0.4}}
        ],
        "user":{
            "uid":"User-1600260845413","properties":{"name":"User-1600260845413","is_in_front":false,"is_speaking":false,"valence":0,"arousal":0,"look_at_pos":[0,0,0],"position":[0,0,100],"orientation":[0,0,0,1]}
        }
    }
};

//Let's assume only 1 agent and user
var agent = behaviorData.env.agents[0];
var user = behaviorData.env.user; 
var graphs = [];
for(var g of behaviorData.env.graphs){
    graphs.push(g);
}